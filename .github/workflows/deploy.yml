name: BelegMeister Deployment

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y tesseract-ocr tesseract-ocr-deu poppler-utils
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run basic health check
      run: |
        python -c "import medical_receipt_tracker; print('âœ… BelegMeister Import erfolgreich')"

  docker-build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: docker build -t belegmeister:latest .
    
    - name: Test Docker image
      run: |
        docker run -d --name test-belegmeister -p 5000:5000 belegmeister:latest
        sleep 30
        curl -f http://localhost:5000/ || (docker logs test-belegmeister && exit 1)
        docker stop test-belegmeister
        docker rm test-belegmeister

  deploy-docs:
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v3
    
    - name: Create GitHub Pages content
      run: |
        mkdir -p docs
        cp README.md docs/index.md
        cp USER_GUIDE.md docs/
        cp INSTALL.md docs/
        echo "# ðŸŽ¯ BelegMeister v1.0 - Dokumentation" > docs/README.md
        echo "" >> docs/README.md
        echo "- [ðŸ“– Benutzerhandbuch](USER_GUIDE.md)" >> docs/README.md
        echo "- [âš™ï¸ Installation](INSTALL.md)" >> docs/README.md
        echo "- [ðŸ  Hauptdokumentation](index.md)" >> docs/README.md
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: docs/
    
    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v2